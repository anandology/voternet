$def with (place)

$var title: $place.name

$ user = get_current_user()
$ place_writable = place.writable_by(user)
$ place_readable = place.writable_by(user, roles=['admin', 'coordinator', 'volunteer', 'pb_agent'])
$ place_admin = place.writable_by(user, roles=['admin'])

$ subtypes = place.get_all_subtypes()

$def render_people(people):
    <table class="table table-bordered">
        $ roles = {"pb_agent": "Polling Booth Agent"}
        $for person in people:
            <tr class="person person-$person.role">
                <td style="width: 20px;">$loop.index</td>
                <td>
                    $if place_writable:
                        <a href="$person.get_url()"><strong>$person.name</strong></a>
                    $else:
                        <strong>$person.name</strong>
                    <small>$roles.get(person.role, person.role.title())</small><br/>
                    $if person.email:
                        <div><span class="glyphicon glyphicon-envelope"></span> <a href="mailto:$person.email">$person.email</a></div>
                    $if person.phone:
                        <div><span class="glyphicon glyphicon-phone-alt"></span> <a href="tel:$person.phone">$person.phone</a></div>
                </td>
            </tr>
    </table>
$code:
    def get_color_class(vcount, count):
        if count == 0:
            return "text-muted"
        elif vcount < count * 0.667:
            return "text-danger"
        elif vcount < count * 1.333:
            return "text-warning"
        else:
            return "text-success"

<ul class="breadcrumb breadcrumb-collapse hidden-print">
    $for p in place.get_parents():
        <li><a href="$p.get_url()">$p.name</a> <span class="divider"></span></li>
</ul>

<div class="row">
  <div class="col-md-9">
    <h1 class="place-h1">$place.name <span class="small">$place.type_label</span></h1>

    <div class="hidden-print">
        <a href="$place.url/info">See info about this place</a>
    </div>

    $ d = place.get_localities()

    <div class="row">
        <div class="col-md-6">
            <h2>Volunteers</h2>
            $if place_readable:
                $ volunteers = place.get_people(roles=["coordinator", "volunteer", "pb_agent"])
            $else:
                $ volunteers = place.get_coordinators()
            $if not volunteers:
                <p><em>None found.</em></p>
            $else:
                $:render_people(volunteers)

          $if place_admin and place.type == "STATE":
              <a href="$place.get_url()/users" class="btn btn-default hidden-print" role="button">See Admin Users</a>
              <br/><br/>

            $if place_writable:
                <div>
                  <a href="$place.get_url()/add-people" class="btn btn-primary active hidden-print" role="button"><span class="glyphicon glyphicon-plus"></span> Volunteer</a>
                  $if place.type == "AC":
                    <a href="$place.get_url()/import-people" class="btn btn-primary active pull-right hidden-print" role="button">Bulk Import Volunteers</a>

                  <br/>
                  <br/>   
                  $if place.type in ["PC", "AC", "WARD"]:
                      <h4>Download <small>as XLS</small></h4>
                      <a href="$place.get_url()/volunteers.xls" class="btn btn-primary active hidden-print pull-left" role="button"><span class="glyphicon glyphicon-download"></span> All Volunteers</a><br/><br/>
                </div>
                $if place.type == 'WARD':
                    <h4>Volunteer Signups</h4>
                    <div class="hidden-print" style="margin: 10px 0px;">
                        $len(place.get_signups()) people have signed up as volunteers at this ward.
                        <br/>
                        <br/>
                        <a href="$place.get_url()/signups" class="btn btn-primary">Review Signups</a>
                    </div>

        </div>
        <div class="col-md-6">
            <h4>Total Volunteers Per Day</h4>
            $:render_template("graph", place.get_volunteer_data_for_graph(), "volunteer-graph")

            <h4>Summary</h4>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled" style="border-left: 5px solid #ddd; padding-left: 10px">
                        $ counts = place.get_counts()
                        $ vcounts = place.get_volunteer_counts()

                        $for t in subtypes:
                            $ count = counts.get(t.code, 0)
                            $ vcount = vcounts.get(t.code, 0)
                            <li class="$get_color_class(vcount, count)"><strong>$commify(vcount)</strong> vols in <strong>$commify(count)</strong> $plural(t.code)</li>
                    </ul>            
                </div>
                <div class="col-md-6">
                    $ summary = place.get_volunteer_summary()
                    <ul class="list-unstyled" style="border-left: 5px solid #ddd; padding-left: 10px">
                        <li>$commify(summary['today']) vols joined today</li>
                        <li>$commify(summary['yesterday']) vols joined yesterday</li>
                        <li>$commify(summary['thisweek']) vols joined this week</li>
                        <li><strong>$commify(summary['total']) vols joined so far</strong></li>
                    </ul>
                </div>
            </div>                
        </div>        
    </div>
    <h2>Coverage <small>Total #houses visited</small></h2>
    <div class="row">
        <div class="col-md-6">
            $:render_template("graph", place.get_coverage_data_for_graph(), "coverage-graph")
        </div>
        <div class="col-md-6">
            $ summary = place.get_coverge_summary()
            <ul class="list-unstyled">
                <li>$commify(summary['today']) houses visited today</li>
                <li>$commify(summary['yesterday']) houses visited yesterday</li>
                <li>$commify(summary['thisweek']) houses visited this week</li>
                <li><strong>$commify(summary['total']) houses visited so far</strong></li>
            </ul>
        </div>
    </div>
    $if place.type == "PB" and place_readable:    
        <h4>Add Coverage</h4>
        <div>
        $ today = get_today().strftime("%A %b %d")
        $ yesterday = get_yesterday().strftime("%A %b %d")

        <a href="$place.get_url()/$get_today().strftime('%Y-%m-%d')" class="btn btn-default" style="line-height: 1.2;"><strong>For Today</strong><br/><small style="color: #444;">$get_today().strftime("%A %b %d")</small></a>
        <a href="$place.get_url()/$get_yesterday().strftime('%Y-%m-%d')" class="btn btn-default" style="line-height: 1.2;"><strong>For Yesterday</strong><br/><small style="color: #444;">$get_yesterday().strftime("%A %b %d")</small></a>
        <a class="btn btn-default" id="coverage-other-date" 
           data-date-format="yyyy-mm-dd" data-date="$get_today().strftime('%Y-%m-%d')"
           style="line-height: 1.2;"><strong>Some Other Date?</strong><br/><small style="color: #888;">&nbsp;</small></a>
        </div>

    $if place_readable:
        <h2>Activity</h2>
        $if place.type in ["STATE", "PC"]:
            $ activities = place.get_activity(limit=5, types=['volunteer-added'])
        $else:
            $ activities = place.get_activity(limit=5)
        $if activities:
            $:render_template("activity", place, activities, header=False)
            <div><a href="$place.get_url()/activity">See more ...</a></div>
        $else:
            <em>No activity yet.</em>

    $def render_place(p, klass, index):
        <tr class="$klass">   
            <td>$index</td>             
            <td><a href="$p.get_url()">$p.name</a></td>
            <td>
                $for person in p.get_coordinators():
                    <div>
                        $if place_writable:
                            <a href="$person.get_url()"><strong>$person.name</strong></a>
                        $else:
                            <strong>$person.name</strong>
                        $if person.email:
                            <div><a href="mailto:$person.email">$person.email</a></div>
                        $if person.phone:
                            <div><a href="tel:$person.phone">$person.phone</a></div>
                    </div>
            </td>
            <td>
                <ul class="list-unstyled">
                    $ counts = p.get_counts()
                    $ vcounts = p.get_volunteer_counts()                    
                    $for t in subtypes[1:]:
                        $ count = counts.get(t.code, 0)
                        $ vcount = vcounts.get(t.code, 0)
                        <li class="$get_color_class(vcount, count)"><strong>$vcount</strong> vols in <strong>$count</strong> $plural(t.code)</li>
                </ul>
            </td>
            <td>
                <strong>$p.get_coverage_count()</strong>
                <small>houses visited</small>
            </td>
        </tr>

    $def render_places_table(places, label):            
        <h2>$label</h2>
        <table class="table table-bordered">
            $ serial = counter()
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Coordinators</th>
                <th>Volunteers</th>
                <th style="width: 200px;">Coverage</th>
            <tr> 
            $for p in places:
                $ counts = p.get_counts()
                $ vcounts = p.get_volunteer_counts()
                $if sum(vcounts.values()):
                    $:render_place(p, "active", serial.next())

            $for p in places:
                $ counts = p.get_counts()
                $ vcounts = p.get_volunteer_counts()
                $if not sum(vcounts.values()):
                    $:render_place(p, "inactive", serial.next())
        </table>    

    $if place.subtype:
        $:render_places_table(place.get_places(), plural(place.subtype_label))

    $if place.type == "AC":
        $ pbs = place.get_unassigned_polling_booths()
        $if pbs:
            $:render_places_table(pbs, "Polling Booths Not Assigned to Any Ward")
    $if place.type == "STATE":
        $ pcs = place.get_unassigned_places(type="PC", parent_type="REGION")
        $if pcs:
            $:render_places_table(pcs, "Parliamentary Constituencies Not Assigned to Any Region")
  </div>
  <div class="col-md-3 sidebar hidden-print">
    $:render_template("place_sidebar", place)
  </div>
</div>


<script type="text/javascript">
var ev_date;
\$(function() {
    var now = new Date();

    \$("a#coverage-other-date").datepicker({
        onRender: function(date) {
            return date.valueOf() > now.valueOf() ? 'disabled' : '';
        }
    }).on("changeDate", function(ev) {
        var d = ev.date;
        // Javascript sucks!
        // This is the shortest I could get to format date as yyyy-mm-dd
        var datestr = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0, 10);
        window.location.href = "$place.get_url()/" + datestr;
    });
});
</script>

